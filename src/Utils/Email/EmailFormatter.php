<?php
/**
 * Date: 22.04.16
 * Time: 21:42
 * Purpose of this class: easy applying mail templates
 * At these moment mail templates are stored in /resources/email
 */

namespace src\Utils\Email;

use src\Models\OcConfig\OcConfig;

class EmailFormatter
{
    private $emailContent;

    public function __construct($emailTemplateFile, $autoLoadTranslations = false)
    {

        $this->emailContent = file_get_contents($emailTemplateFile);

        if ($autoLoadTranslations) {
            $this->loadTranslations();
        }
    }

    /**
     * @param string $variable
     * @param string $value
     * @return $this
     */
    public function setVariable($variable, $value)
    {
        $this->emailContent = mb_ereg_replace("{".$variable."}", $value, $this->emailContent);

        return $this;
    }

    public function getEmailContent()
    {
        return $this->emailContent;
    }

    /**
     * @param string $username //because we always write to somebody with oc nick
     * @param bool $autoGenerated //if you don't want to add 'mail_auto_generated' text into footer - set it to false
     * @return EmailFormatter
     */
    public function addFooterAndHeader($username, $autoGenerated = true)
    {
        $footer = new EmailFormatter(__DIR__."/../../../resources/email/ocFooter.email.html");
        $header = new EmailFormatter(__DIR__."/../../../resources/email/ocHeader.email.html");

        $footer->setVariable("octeamEmailsSignature", OcConfig::getOcteamEmailsSignature());

        if ($autoGenerated) {
            $footer->setVariable("mail_auto_generated", tr("mail_auto_generated"));
        } else {
            $footer->setVariable("mail_auto_generated", tr("mail_replyAllowed"));
        }

        $header->setVariable("server", OcConfig::getAbsolute_server_URI());
        $header->setVariable("oc_logo", OcConfig::getEmailHeaderLogo());
        $header->setVariable("sitename", OcConfig::getSiteName());
        $header->setVariable("short_sitename", OcConfig::getSiteShortName());
        $header->setVariable("mail_header_hi", tr("mail_header_hi"));
        $header->setVariable("user", $username);

        $this->emailContent = $header->getEmailContent().$this->emailContent.$footer->getEmailContent();

        return $this;
    }

    /**
     * this method provide translation in email templates
     * It looks for {{transl_key}} phases and replace it to proper translation string
     */
    private function loadTranslations()
    {
        if (preg_match_all("/{{[^}]*}}/u", $this->emailContent, $matches)) {

            foreach ($matches[0] as $translationPhase) {
                $translationKey = substr($translationPhase, 2, -2);
                $this->emailContent = preg_replace("/$translationPhase/u", tr($translationKey), $this->emailContent);
            }
        }
    }

}
